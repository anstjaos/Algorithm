```java
class Solution {
    public int largestMagicSquare(int[][] grid) {
        int row = grid.length, col = grid[0].length;
        if (row < 2 || col < 2) return 1;
        
        int[][] rowSum = new int[row][col];
        for (int i = 0; i < row; i++) {
            rowSum[i][0] = grid[i][0];
            for (int j = 1; j < col; j++) {
                rowSum[i][j] = rowSum[i][j - 1] + grid[i][j];
            }
        }

        int[][] colSum = new int[row][col];
        for (int j = 0; j < col; j++) {
            colSum[0][j] = grid[0][j];
            for (int i = 1; i < row; i++) {
                colSum[i][j] = colSum[i - 1][j] + grid[i][j];
            }
        }
        
        int maxSize = 1;

        for (int i = 0; i < row; i++) {
            for (int j = 0; j < col; j++) {
                int max = Math.min(row - i, col - j);

                for (int size = max; size > maxSize; size--) {
                    if (isMagic(i, j, size, grid, rowSum, colSum)) {
                        maxSize = size;
                        break;
                    }
                }
            }
        }

        return maxSize;
    }

    private boolean isMagic(int row, int col, int size, int[][] grid, int[][] rowSum, int[][] colSum) {
        int target = rowSum[row][col + size - 1] - (col > 0 ? rowSum[row][col - 1] : 0);

        for (int i = row; i < row + size; i++) {
            int sum = rowSum[i][col + size - 1] - (col > 0 ? rowSum[i][col - 1] : 0);
            if (sum != target) return false;
        } 

        for (int i = col; i < col + size; i++) {
            int sum = colSum[row + size - 1][i] - (row > 0 ? colSum[row - 1][i] : 0);
            if (sum != target) return false;
        }

        int d1 = 0;
        for (int i = 0; i < size; i++) {
            d1 += grid[row + i][col + i];
        }
        if (d1 != target) return false;

        int d2 = 0;
        for (int i = 0; i < size; i++) {
            d2 += grid[row + size - 1 - i][col + i];
        }
        
        return d2 == target;
    }
}
```